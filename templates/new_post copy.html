
{% extends "base.html" %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title">Create New Template</h1>
        <form action="/add-new-post/" method="post" id="template-form" onsubmit="return validateForm()" novalidate>
            <!-- Template Name -->
            <div class="field">
                <label class="label" for="template_name">Template Name</label>
                <div class="control">
                    <input class="input" type="text" id="template_name" name="template_name" required>
                </div>
            </div>

            <!-- Category -->
            <div class="field">
                <label class="label" for="category">Category</label>
                <div class="control">
                    <div class="select">
                        <select id="category" name="category" required>
                            <option value="none">Please Choose Category</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="reviews">Reviews</option>
                            <option value="technology">Technology</option>
                            <option value="random-thoughts">Random Thoughts</option>
                            <option value="stock-market">Stock Market</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Subcategory -->
            <div class="field">
                <label class="label" for="subcategory">Subcategory</label>
                <div class="control">
                    <div class="select">
                        <select id="subcategory" name="subcategory" required>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Front Matter Section -->
            <h3 class="subtitle">Front Matter</h3>
            <div class="field">
                <label class="label" for="description">Description</label>
                <div class="control">
                    <input class="input" type="text" id="description" name="description" required>
                </div>
            </div>

            <div class="field">
                <label class="label" for="keywords">Keywords (comma-separated)</label>
                <div class="control">
                    <input class="input" type="text" id="keywords" name="keywords" required>
                </div>
            </div>

            <div class="field">
                <label class="label" for="date">Date</label>
                <div class="control">
                    <input class="input" type="date" id="date" name="date" required>
                </div>
            </div>

            <div class="field">
                <label class="checkbox">
                    <input type="checkbox" id="draft" name="draft"> Draft
                </label>
            </div>

            <!-- Open Graph Metadata Section -->
            <h3 class="subtitle">Open Graph Metadata</h3>
            <div class="field">
                <label class="label" for="og_title">OG Title</label>
                <div class="control">
                    <input class="input" type="text" id="og_title" name="og_title">
                </div>
            </div>

            <div class="field">
                <label class="label" for="og_description">OG Description</label>
                <div class="control">
                    <input class="input" type="text" id="og_description" name="og_description">
                </div>
            </div>

            <div class="field">
                <label class="label" for="og_image">OG Image Path</label>
                <div class="control">
                    <input class="input" type="text" id="og_image" name="og_image">
                </div>
            </div>

            <div class="field">
                <label class="label" for="og_url">OG URL</label>
                <div class="control">
                    <input class="input" type="text" id="og_url" name="og_url">
                </div>
            </div>

            <div class="field">
                <label class="label" for="og_type">OG Type</label>
                <div class="control">
                    <input class="input" type="text" id="og_type" name="og_type" value="article">
                </div>
            </div>

            <!-- Additional Meta Tags Section -->
            <h3 class="subtitle">Additional Meta Tags</h3>
            <div class="field">
                <label class="label" for="author">Author Name</label>
                <div class="control">
                    <input class="input" type="text" id="author" name="author">
                </div>
            </div>

            <div class="field">
                <label class="label" for="viewport">Viewport</label>
                <div class="control">
                    <input class="input" type="text" id="viewport" name="viewport" value="width=device-width, initial-scale=1">
                </div>
            </div>

            <!-- JSON-LD Metadata Section -->
            <h3 class="subtitle">JSON-LD Metadata</h3>
            <div class="field">
                <label class="label" for="json_ld_name">JSON-LD Name</label>
                <div class="control">
                    <input class="input" type="text" id="json_ld_name" name="json_ld_name">
                </div>
            </div>

            <div class="field">
                <label class="label" for="json_ld_description">JSON-LD Description</label>
                <div class="control">
                    <input class="input" type="text" id="json_ld_description" name="json_ld_description">
                </div>
            </div>

            <div class="field">
                <label class="label" for="json_ld_url">JSON-LD URL</label>
                <div class="control">
                    <input class="input" type="text" id="json_ld_url" name="json_ld_url">
                </div>
            </div>

            <!-- Toast UI Editor HTML -->
            <div class="field">
                <label class="label">Content</label>
                <div class="control">
                    <div id="editor" style="min-height: 500px; border: 1px solid #ccc;"></div>
                </div>
            </div>

            <!-- Make the textarea visually hidden but still focusable -->
            <textarea name="content" id="editor-content" style="height: 0; opacity: 0;" required></textarea>

            <div class="field">
                <div class="control">
                    <button class="button is-primary" type="submit">Create Template</button>
                </div>
            </div>
        </form>
    </div>
</section>

<!-- Toast UI Editor Core -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<!-- Corrected Plugin Sources -->
<script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.js"></script>
<script src="https://uicdn.toast.com/editor-plugin-table-merged-cell/latest/toastui-editor-plugin-table-merged-cell.min.js"></script>
<script src="https://uicdn.toast.com/editor-plugin-uml/latest/toastui-editor-plugin-uml.min.js"></script>

<style>
    .tui-editor {
        background-color: #1e1e1e; /* Example for dark mode */
        color: white;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const Editor = toastui.Editor;

    const editor = new Editor({
        el: document.querySelector('#editor'),
        height: '500px',
        initialEditType: 'markdown',
        previewStyle: 'vertical',
        extendedAutolinks: true,
        frontMatter: true,
        plugins: [
            toastui.Editor.plugin.codeSyntaxHighlight,
            toastui.Editor.plugin.tableMergedCell,
            toastui.Editor.plugin.uml
        ],
        hook: {
            addImageBlobHook: (blob, callback) => {
                const reader = new FileReader();
                reader.onload = () => {
                    callback(reader.result, blob.name);
                };
                reader.readAsDataURL(blob);
            }
        }
    });

    // Validate form fields
    window.validateForm = function() {
        const templateName = document.getElementById('template_name').value.trim();
        const category = document.getElementById('category').value;
        const description = document.getElementById('description').value.trim();
        const keywords = document.getElementById('keywords').value.trim();
        const date = document.getElementById('date').value;
        const editorContent = editor.getHTML();

        let valid = true;

        // Clear previous error messages
        document.querySelectorAll('.error-message').forEach(el => el.remove());

        // Check required fields
        if (!templateName) {
            showError('Template Name is required.');
            valid = false;
        }
        if (category === 'none') {
            showError('Please choose a category.');
            valid = false;
        }
        if (!description) {
            showError('Description is required.');
            valid = false;
        }
        if (!keywords) {
            showError('Keywords are required.');
            valid = false;
        }
        if (!date) {
            showError('Date is required.');
            valid = false;
        }
        if (!editorContent) {
            showError('Content is required.');
            valid = false;
        }

        if (valid) {
            document.getElementById('editor-content').value = editorContent; // Set the value of the textarea
        }

        return valid; // Allow submission if all validations pass
    };

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message has-text-danger';
        errorDiv.innerText = message;
        document.querySelector('.container').appendChild(errorDiv);
    }

    // Subcategories data
    const subcategories = {
        "lifestyle": ["Parenting", "Yoga", "Travel", "Food", "Fashion", "Minimalism", "Health and Wellness"],
        // "technology": ["Gadgets", "AI", "Programming", "LLM"]
    };

    // Function to dynamically update subcategories based on selected category
    function updateSubcategories() {
        const categorySelect = document.getElementById('category');
        const subcategorySelect = document.getElementById('subcategory');
        const selectedCategory = categorySelect.value;

        // Clear existing subcategories
        subcategorySelect.innerHTML = '';

        if (subcategories.hasOwnProperty(selectedCategory)) {
            subcategories[selectedCategory].forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory.toLowerCase().replace(/\s+/g, '-');
                option.textContent = subcategory;
                subcategorySelect.appendChild(option);
            });
            subcategorySelect.disabled = false;
        } else {
            const noneOption = document.createElement('option');
            noneOption.value = "none";
            noneOption.textContent = "None";
            subcategorySelect.appendChild(noneOption);
            subcategorySelect.disabled = true;
        }
    }

    // Add event listener for category changes
    const categorySelect = document.getElementById('category');
    categorySelect.addEventListener('change', updateSubcategories);

    // Initialize subcategories on page load
    updateSubcategories();
});
</script>
{% endblock %}
