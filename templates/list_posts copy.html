{% extends "base.html" %}

{% block content %}
    <div class="container">
        <h1 class="title is-3">Markdown Files</h1>
        <form action="/markdown/" method="get" class="field has-addons">
            <div class="control is-expanded">
                <input class="input" type="text" name="search" placeholder="Search Markdown files...">
            </div>
            <div class="control">
                <button class="button is-info" type="submit">Search</button>
            </div>
        </form>

        <div class="content">
            <ul class="menu">
                {% for file in markdown_files %}
                    {% set parts = file.split(' -> ') %}
                    {% set category = parts[1] %}
                    {% set subcategory = parts[2] if parts|length > 3 else '' %}
                    {% set file_name = parts[-1] %}

                    <li class="menu-item">
                        <div class="columns is-vcentered">
                            <div class="column">
                                <p class="title is-6">{{ file }}</p>
                            </div>
                            <div class="column is-narrow">
                                <div class="buttons">
                                    <a class="button is-info is-small" href="/markdown/edit/{{ file | url_encode }}" title="Edit this file">Edit</a>
                                    <button class="button is-danger is-small delete-btn"
                                            data-category="{{ category }}"
                                            data-subcategory="{{ subcategory }}"
                                            data-file-name="{{ file_name }}"
                                            title="Delete this file">Delete</button>
                                </div>
                            </div>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="pagination is-centered">
            {% if page > 1 %}
                <a class="pagination-previous" href="/markdown/?page={{ page - 1 }}&section={{ section }}">Previous</a>
            {% endif %}
            {% if page < total_pages %}
                <a class="pagination-next" href="/markdown/?page={{ page + 1 }}&section={{ section }}">Next</a>
            {% endif %}
        </div>

        <a class="button is-link" href="/">Back to Home</a>
    </div>

    <script>
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const category = event.target.getAttribute('data-category');
                const subcategory = event.target.getAttribute('data-subcategory');
                const fileName = event.target.getAttribute('data-file-name');

                // Construct the URL for deletion
                let url = `/markdown/delete/${encodeURIComponent(category)}`;
                if (subcategory) {
                    url += `/${encodeURIComponent(subcategory)}`;
                }
                url += `/${encodeURIComponent(fileName)}`;

                // Log the URL for debugging
                console.log('Deleting URL:', url);

                // Confirm deletion
                const confirmDelete = confirm('Are you sure you want to delete this file?');
                if (!confirmDelete) return;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    if (response.ok) {
                        alert('File deleted successfully.');
                        location.reload(); // Reload the page to see changes
                    } else {
                        alert('Failed to delete the file.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the file.');
                }
            });
        });
    </script>
{% endblock %}
