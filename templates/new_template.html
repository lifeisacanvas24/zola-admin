{% extends "base.html" %}

{% block content %}
    <section class="section">
        <div class="container">
            <h1 class="title">Create New Template</h1>
            <form action="/templates/new/" method="post" id="template-form" onsubmit="submitContent()">
                <!-- Template Name (serves as Title) -->
                <div class="field">
                    <label class="label" for="template_name">Template Name</label>
                    <div class="control">
                        <input class="input" type="text" id="template_name" name="template_name" required>
                    </div>
                </div>

                <!-- Category -->
                <div class="field">
                    <label class="label" for="category">Category</label>
                    <div class="control">
                        <div class="select">
                            <select id="category" name="category">
                                <option value="none">Please Choose Category</option>
                                <option value="lifestyle">Lifestyle</option>
                                <option value="reviews">Reviews</option>
                                <option value="technology">Technology</option>
                                <option value="random-thoughts">Random Thoughts</option>
                                <option value="stock-market">Stock Market</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Subcategory (Dynamically updated) -->
                <div class="field">
                    <label class="label" for="subcategory">Subcategory</label>
                    <div class="control">
                        <div class="select">
                            <select id="subcategory" name="subcategory">
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Front Matter Section -->
                <h3 class="subtitle">Front Matter</h3>

                <div class="field">
                    <label class="label" for="description">Description</label>
                    <div class="control">
                        <input class="input" type="text" id="description" name="description" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="keywords">Keywords (comma-separated)</label>
                    <div class="control">
                        <input class="input" type="text" id="keywords" name="keywords" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="date">Date</label>
                    <div class="control">
                        <input class="input" type="date" id="date" name="date" required>
                    </div>
                </div>

                <div class="field">
                    <label class="checkbox">
                        <input type="checkbox" id="draft" name="draft"> Draft
                    </label>
                </div>

                <!-- Open Graph Metadata Section -->
                <h3 class="subtitle">Open Graph Metadata</h3>

                <div class="field">
                    <label class="label" for="og_title">OG Title</label>
                    <div class="control">
                        <input class="input" type="text" id="og_title" name="og_title">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="og_description">OG Description</label>
                    <div class="control">
                        <input class="input" type="text" id="og_description" name="og_description">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="og_image">OG Image Path</label>
                    <div class="control">
                        <input class="input" type="text" id="og_image" name="og_image">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="og_url">OG URL</label>
                    <div class="control">
                        <input class="input" type="text" id="og_url" name="og_url">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="og_type">OG Type</label>
                    <div class="control">
                        <input class="input" type="text" id="og_type" name="og_type" value="article">
                    </div>
                </div>

                <!-- Additional Meta Tags Section -->
                <h3 class="subtitle">Additional Meta Tags</h3>

                <div class="field">
                    <label class="label" for="author">Author Name</label>
                    <div class="control">
                        <input class="input" type="text" id="author" name="author">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="viewport">Viewport</label>
                    <div class="control">
                        <input class="input" type="text" id="viewport" name="viewport" value="width=device-width, initial-scale=1">
                    </div>
                </div>

                <!-- JSON-LD Metadata Section -->
                <h3 class="subtitle">JSON-LD Metadata</h3>

                <div class="field">
                    <label class="label" for="json_ld_name">JSON-LD Name</label>
                    <div class="control">
                        <input class="input" type="text" id="json_ld_name" name="json_ld_name">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="json_ld_description">JSON-LD Description</label>
                    <div class="control">
                        <input class="input" type="text" id="json_ld_description" name="json_ld_description">
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="json_ld_url">JSON-LD URL</label>
                    <div class="control">
                        <input class="input" type="text" id="json_ld_url" name="json_ld_url">
                    </div>
                </div>

                <!-- Toast UI Editor HTML -->
                <div class="field">
                    <label class="label">Content</label>
                    <div class="control">
                        <div id="editor"></div>
                    </div>
                </div>

                <!-- Hidden textarea for editor content -->
                <textarea name="content" id="editor-content" style="display:none;" required></textarea>

                <div class="field">
                    <div class="control">
                        <button class="button is-primary" type="submit">Create Template</button>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <!-- Toast UI CSS and JS -->
       <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
       <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

       <script>
           // Subcategories data - can be easily extended in the future
           const subcategories = {
               "lifestyle": ["Parenting", "Yoga", "Travel", "Food", "Fashion", "Minimalism", "Health and Wellness"]
               // Example of how to add a new category with subcategories in the future:
               // "technology": ["Gadgets", "Software", "AI", "Blockchain"]
           };

           // Function to dynamically update subcategories based on selected category
           function updateSubcategories() {
               const categorySelect = document.getElementById('category');
               const subcategorySelect = document.getElementById('subcategory');
               const selectedCategory = categorySelect.value;

               console.log("Selected category:", selectedCategory);  // Debug log

               // Clear existing subcategories
               subcategorySelect.innerHTML = '';

               // Check if the selected category has subcategories
               if (subcategories.hasOwnProperty(selectedCategory) && subcategories[selectedCategory].length > 0) {
                   subcategories[selectedCategory].forEach(subcategory => {
                       const option = document.createElement('option');
                       option.value = subcategory.toLowerCase().replace(/\s+/g, '-');
                       option.textContent = subcategory;
                       subcategorySelect.appendChild(option);
                   });
                   console.log(`Subcategories added for ${selectedCategory}`);  // Debug log
                   subcategorySelect.disabled = false;
               } else {
                   // Add 'None' option for categories without subcategories
                   const noneOption = document.createElement('option');
                   noneOption.value = "none";
                   noneOption.textContent = "None";
                   subcategorySelect.appendChild(noneOption);
                   console.log("No subcategories for this category, added 'None' option");  // Debug log
                   subcategorySelect.disabled = true;
               }
           }

           // Initialize the Toast UI editor
           let editor;

           // Function to set editor content to textarea on form submit
           function submitContent() {
               const editorContent = editor.getMarkdown();
               document.getElementById('editor-content').value = editorContent;
           }

           // Initialize everything when the DOM is fully loaded
           document.addEventListener('DOMContentLoaded', function() {
               console.log("DOM fully loaded");  // Debug log

               // Initialize the Toast UI editor
               try {
                   editor = new toastui.Editor({
                       el: document.querySelector('#editor'),
                       initialEditType: 'markdown',
                       previewStyle: 'vertical',
                       height: '500px',
                       initialValue: '',
                       plugins: [
                           toastui.Editor.plugin.chart,
                           toastui.Editor.plugin.codeSyntaxHighlight,
                       ]
                   });
                   console.log("Toast UI Editor initialized successfully");  // Debug log
               } catch (error) {
                   console.error("Error initializing Toast UI Editor:", error);  // Debug log
               }

               // Add event listener for category changes
               const categorySelect = document.getElementById('category');
               if (categorySelect) {
                   categorySelect.addEventListener('change', updateSubcategories);
                   console.log("Event listener added to category select");  // Debug log
               } else {
                   console.error("Category select element not found");  // Debug log
               }

               // Call this once on page load to populate initial subcategories
               updateSubcategories();
           });
       </script>
   {% endblock %}
